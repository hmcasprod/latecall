<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDpbeGkKN3q0_rUTnBHUjT0133w1HuzHcI",
    authDomain: "hmcas-late-call.firebaseapp.com",
    projectId: "hmcas-late-call",
    storageBucket: "hmcas-late-call.firebasestorage.app",
    messagingSenderId: "88186358109",
    appId: "1:88186358109:web:67981ae5cbbba348b700b4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Managers
let managers = [
  { username: "jcamins", fullName: "James Camins", corpNumber: "45357", password: "HMCAS1234" },
  { username: "hkerkeni", fullName: "Habib Kerkeni", corpNumber: "11748", password: "HMCAS1234" }
];

// Live submissions array
let submissions = [];

// Auto logout
let logoutTimer;
function resetTimer(){
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(()=>{ alert("Logged out due to inactivity."); logout(); },5*60*1000);
}
document.onmousemove = resetTimer;
document.onkeydown = resetTimer;

// Login & Logout
function login(){
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const manager = managers.find(m=>m.username===username && m.password===password);
    if(manager){
        localStorage.setItem('currentManager', JSON.stringify(manager));
        checkLogin();
    } else { document.getElementById('errorMessage').innerText="Invalid username or password!"; }
}
function logout(){
    localStorage.removeItem('currentManager');
    document.getElementById('loginPage').style.display='flex';
    document.getElementById('dashboardPage').style.display='none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
}

// Check login
function checkLogin(){
    const manager = JSON.parse(localStorage.getItem('currentManager'));
    if(manager){
        document.getElementById('loginPage').style.display='none';
        document.getElementById('dashboardPage').style.display='block';
        document.getElementById('managerName').innerText = `${manager.fullName} ${manager.corpNumber}`;
        resetTimer();
        loadFirebaseSubmissions();
    }
}

// Format date/time
function formatDateTime(dateString){
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const d=new Date(dateString);
    let day=d.getDate().toString().padStart(2,'0');
    let month=months[d.getMonth()];
    let year=d.getFullYear();
    let hours=d.getHours().toString().padStart(2,'0');
    let minutes=d.getMinutes().toString().padStart(2,'0');
    return `${day}-${month}-${year} ${hours}:${minutes}`;
}

// Load submissions from Firebase
function loadFirebaseSubmissions(){
    const q = query(collection(db, "requests"), orderBy("timestamp","desc"));
    onSnapshot(q, snapshot => {
        submissions = [];
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            submissions.push({ 
                id: docSnap.id,
                date: data.date,
                name: data.name,
                corp: data.corp,
                hub: data.hub,
                unit: data.unit,
                shift: data.shift,
                trip: data.trip,
                hours: data.hours,
                status: data.status,
                processedBy: data.processedBy,
                completedAt: data.completedAt ? data.completedAt.toDate() : null
            });
        });
        loadManagerTable();
    });
}

// Load table with filters
function loadManagerTable(){
    const tbody = document.querySelector('#requestsTable tbody');
    tbody.innerHTML='';
    const hubFilter = document.getElementById('hubFilter').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const manager = JSON.parse(localStorage.getItem('currentManager'));

    submissions.filter(s=>{
        const matchHub = !hubFilter || s.hub.toLowerCase()===hubFilter;
        const matchDate = !dateFilter || s.date.split('T')[0] === dateFilter;
        const matchSearch = !searchTerm || 
            s.name.toLowerCase().includes(searchTerm) ||
            s.corp.toLowerCase().includes(searchTerm) ||
            (s.trip && s.trip.toLowerCase().includes(searchTerm)) ||
            (s.unit && s.unit.toLowerCase().includes(searchTerm));
        return matchHub && matchDate && matchSearch;
    }).forEach((s,i)=>{
        let statusClass = s.status==='Pending'?'status-pending':'status-completed';
        let disabled = s.status==='Completed' ? 'disabled' : '';
        let statusHTML = `<select class="status-select ${statusClass}" onchange="updateStatusFirebase('${s.id}', this)" ${disabled}>
            <option value="Pending" ${s.status==='Pending'?'selected':''}>Pending</option>
            <option value="Completed" ${s.status==='Completed'?'selected':''}>Completed</option>
        </select>`;
        if(s.status==='Completed') statusHTML += ` by ${s.processedBy||manager.fullName} (${s.completedAt ? formatDateTime(s.completedAt) : ''})`;

        tbody.innerHTML += `<tr>
            <td>${formatDateTime(s.date)}</td>
            <td>${s.name}</td>
            <td>${s.corp}</td>
            <td>${s.hub}</td>
            <td>${s.unit}</td>
            <td>${s.shift}</td>
            <td>${s.trip || ''}</td>
            <td>${s.hours}</td>
            <td>${statusHTML}</td>
        </tr>`;
    });
}

// Update status in Firebase
async function updateStatusFirebase(docId, selectElem){
    const value = selectElem.value;
    if(value==='Completed'){
        const manager = JSON.parse(localStorage.getItem('currentManager'));
        const docRef = doc(db,"requests", docId);
        await updateDoc(docRef,{
            status: "Completed",
            processedBy: manager.fullName,
            completedAt: new Date()
        });
        selectElem.disabled = true;
        selectElem.className = 'status-select status-completed';
    }
}

// Export CSV
function exportToExcel(){
    const hubFilter = document.getElementById('hubFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    let filtered = submissions.filter(s=>{
        const matchHub = !hubFilter || s.hub===hubFilter;
        const matchDate = !dateFilter || s.date.split('T')[0] === dateFilter;
        const matchSearch = !searchTerm ||
            s.name.toLowerCase().includes(searchTerm) ||
            s.corp.toLowerCase().includes(searchTerm) ||
            (s.trip && s.trip.toLowerCase().includes(searchTerm)) ||
            (s.unit && s.unit.toLowerCase().includes(searchTerm));
        return matchHub && matchDate && matchSearch;
    });

    if(filtered.length===0){ alert("No data to export!"); return; }

    let csv="Date,Name,Corp,HUB,Unit,Shift,Trip,Hours,Status,Processed By,Completed At\n";
    filtered.forEach(s=>{
        csv+=`${formatDateTime(s.date)},${s.name},${s.corp},${s.hub},${s.unit},${s.shift},${s.trip||''},${s.hours},${s.status},${s.processedBy||''},${s.completedAt?s.completedAt:' '}\n`;
    });
    const blob=new Blob([csv], {type:'text/csv'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download="LateCallRequests.csv";
    a.click();
}

// Init
checkLogin();
</script>
