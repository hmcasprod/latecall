<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supervisor Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Add your existing CSS styles here */
    </style>
</head>
<body>

<!-- Logo Header -->
<div class="header-logos">
    <img src="logo1.png" alt="Logo 1">
    <img src="logo2.png" alt="Logo 2">
</div>

<!-- Login Page -->
<div id="loginPage">
    <div class="login-container">
        <h2>Manager Login</h2>
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <div id="errorMessage" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage">
    <!-- Dashboard Content Here -->
</div>

<!-- Firebase SDK Integration -->
<!-- Firebase Core -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<!-- Firestore SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyC-RidAbJBCvoxT6aalA-lXA1u5ZT1PC4o",
    authDomain: "hmcas-latecall.firebaseapp.com",
    projectId: "hmcas-latecall",
    storageBucket: "hmcas-latecall.appspot.com",
    messagingSenderId: "498700648548",
    appId: "1:498700648548:web:393d1676210823f7f49f71"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);

// Managers
let managers = [
    { username: "jcamins", fullName: "James Camins", corpNumber: "45357", password: "HMCAS1234" },
    { username: "hkerkeni", fullName: "Habib Kerkeni", corpNumber: "11748", password: "HMCAS1234" }
];

// Auto logout 5 mins
let logoutTimer;
function resetTimer(){
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(()=>{ alert("Logged out due to inactivity."); logout(); },5*60*1000);
}
document.onmousemove = resetTimer;
document.onkeydown = resetTimer;

// Login
function login(){
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const manager = managers.find(m=>m.username===username && m.password===password);
    if(manager){
        localStorage.setItem('currentManager', JSON.stringify(manager));
        checkLogin();
    } else { document.getElementById('errorMessage').innerText="Invalid username or password!"; }
}

function logout(){
    localStorage.removeItem('currentManager');
    document.getElementById('loginPage').style.display='flex';
    document.getElementById('dashboardPage').style.display='none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
}

// Check login state
function checkLogin(){
    const manager = JSON.parse(localStorage.getItem('currentManager'));
    if(manager){
        document.getElementById('loginPage').style.display='none';
        document.getElementById('dashboardPage').style.display='block';
        document.getElementById('managerName').innerText = `${manager.fullName} ${manager.corpNumber}`;
        resetTimer();
        loadManagerTable();
    }
}

// Fetch data from Firestore
function loadManagerTable() {
    const tbody = document.querySelector('#requestsTable tbody');
    tbody.innerHTML = '';

    // Get filter values
    const hubFilter = document.getElementById('hubFilter').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    db.collection('requests').get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                let s = doc.data();
                const matchHub = !hubFilter || s.hub.toLowerCase() === hubFilter;
                const matchDate = !dateFilter || s.date.split('T')[0] === dateFilter;
                const matchSearch = !searchTerm ||
                    s.name.toLowerCase().includes(searchTerm) ||
                    s.corp.toLowerCase().includes(searchTerm) ||
                    (s.trip && s.trip.toLowerCase().includes(searchTerm)) ||
                    (s.unit && s.unit.toLowerCase().includes(searchTerm));

                if (matchHub && matchDate && matchSearch) {
                    let statusClass = s.status === 'Pending' ? 'status-pending' : 'status-completed';
                    let disabled = s.status === 'Completed' ? 'disabled' : '';
                    let statusHTML = `<select class="status-select ${statusClass}" onchange="updateStatus('${doc.id}', this)" ${disabled}>
                        <option value="Pending" ${s.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Completed" ${s.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>`;
                    if (s.status === 'Completed') statusHTML += ` by ${s.processedBy || 'Supervisor'} (${formatDateTime(s.completedAt)})`;

                    tbody.innerHTML += `<tr>
                        <td>${formatDateTime(s.date)}</td>
                        <td>${s.name}</td>
                        <td>${s.corp}</td>
                        <td>${s.hub}</td>
                        <td>${s.unit}</td>
                        <td>${s.shift}</td>
                        <td>${s.trip}</td>
                        <td>${s.timeout}</td>
                        <td>${statusHTML}</td>
                    </tr>`;
                }
            });
        })
        .catch(error => {
            console.error("Error fetching requests: ", error);
        });
}

// Update status in Firestore
function updateStatus(docId, selectElem) {
    const value = selectElem.value;
    const manager = JSON.parse(localStorage.getItem('currentManager'));

    if (value === 'Completed') {
        db.collection('requests').doc(docId).update({
            status: 'Completed',
            processedBy: manager.fullName,
            completedAt: new Date()
        }).then(() => {
            loadManagerTable();
        }).catch(error => {
            console.error("Error updating status: ", error);
        });
    }
}

// Format date with time
function formatDateTime(dateString) {
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const d = new Date(dateString);
    let day = d.getDate().toString().padStart(2, '0');
    let month = months[d.getMonth()];
    let year = d.getFullYear();
    let hours = d.getHours().toString().padStart(2, '0');
    let minutes = d.getMinutes().toString().padStart(2, '0');
    return `${day}-${month}-${year} ${hours}:${minutes}`;
}

</script>

<footer>
    Â© 2026 HMCAS Support Service Production. <br>
    James Ross Camins. All rights reserved.
</footer>

</body>
</html>
